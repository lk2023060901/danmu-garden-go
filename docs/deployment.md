# 部署与云主机规划

本文档说明分布式游戏服务器的部署方式、云主机配置和扩展策略，以支撑 ≥ 1 万并发连接为目标。

## 一、部署形态概览

- **容器化部署**：所有服务（gateway/game/match/user 等）以容器形式运行。
- **编排系统**：推荐使用 Kubernetes（K8s），便于扩缩容和服务发现。
- **负载均衡**：
  - 外部流量：使用云厂商 SLB/ELB 将流量分发到网关服务。
  - 内部流量：K8s Service（ClusterIP）或 Service Mesh（可选）。
- **全区全服**：
  - 不做物理大区拆分，通过逻辑分区（标签、服标记）实现分区玩法。
  - 单集群可水平扩展至多节点，保证总体并发能力。

## 二、云主机配置与数量（生产环境初始规划）

以下以支撑 1–2 万长连接并发为初始目标，考虑冗余：

### 1. 网关节点（WebSocket/gRPC）

- 规格建议：
  - 8 vCPU / 16 GB 内存。
  - 单节点千兆网卡。
- 部署策略：
  - 每台物理机（或云主机）上运行 3–4 个网关 Pod。
  - 每个 Pod 目标 2–3k 并发连接。
- 数量建议：
  - 3 台云主机 → 理论可支撑约 18k–24k 并发连接（保守估算）。

### 2. 业务节点（game/match/user 等）

- 规格建议：
  - 8 vCPU / 32 GB 内存。
- 部署策略：
  - `game`、`match`、`user` 等服务以多副本形式运行，具体副本数根据压测结果调整。
- 数量建议：
  - 3 台云主机，跨可用区部署，提高可用性。

### 3. 基础设施节点

#### PostgreSQL

- 优先选择云厂商托管 RDS：
  - 主实例：8 vCPU / 32 GB，SSD 磁盘 1 TB 起。
  - 从实例：1 台同规格，从库用于读流量和备灾。
- 部署建议：
  - 开启自动备份与快照。
  - 配置只读实例用于报表或低优先级查询。

#### Redis

- 使用托管 Redis Cluster 或自建集群：
  - 3 个分片，每分片：2 vCPU / 8 GB。
  - 每个分片配置主从各 1 节点。
- 用途：
  - 匹配队列、在线状态、排行榜、热点配置等。

#### 消息队列（Kafka/NATS）

- 初期可使用云托管 MQ 或在业务节点上部署小规模集群。
- 后续根据流量拆分为独立节点或使用专用实例。

### 4. 控制平面与其他

- Kubernetes 控制节点（Master）：
  - 3 台小规格节点（如 2 vCPU / 8 GB），用于集群管理。
- 运维与监控系统：
  - Prometheus、Grafana、Jaeger/Tempo 等，可与上述节点复用或独立部署。

### 5. 数量汇总

- 应用节点（Worker）：
  - 网关节点：3 台。
  - 业务节点：3 台。
- 控制节点（Master）：
  - 3 台小规格。
- 托管服务：
  - PostgreSQL RDS：1 主 1 从。
  - Redis 集群：3 分片主从。

## 三、Kubernetes 部署示意

- `deploy/k8s/gateway-deployment.yaml`
  - 定义网关 Deployment、Service、HPA。
- `deploy/k8s/game-deployment.yaml`
  - 游戏服务 Deployment 和 Service。
- `deploy/k8s/match-deployment.yaml`
  - 匹配服务 Deployment 和 Service。
- `deploy/k8s/user-deployment.yaml`
  - 用户服务 Deployment 和 Service。
- `deploy/k8s/ingress.yaml`
  - 对接云负载均衡，将外部流量导入网关 Service。

## 四、扩容与高可用策略

### 1. 水平扩容

- 网关层：
  - 通过 K8s HPA 根据 CPU 使用率、连接数指标自动扩缩容。
- 业务层：
  - 根据 QPS、请求延迟和队列长度等指标调整副本数。

### 2. 故障容错

- 多可用区部署：
  - 网关和业务节点分布在不同可用区。
- 健康检查：
  - 使用 K8s liveness/readiness 探针移除异常实例。
- 降级策略：
  - 当部分服务不可用时，提供降级体验，例如只允许匹配但不记录战绩。

### 3. 数据安全

- PostgreSQL：
  - 开启自动备份，定期进行备份恢复演练。
  - 使用只读实例承载报表和重查询。
- Redis：
  - 配置持久化（AOF/RDB），防止缓存丢失影响游戏状态。

## 五、环境划分

- **开发环境（dev）**：
  - 可使用最小规格机器和单实例 Redis/PG，部署变更频繁。
- **测试/预发环境（staging）**：
  - 与生产尽可能一致的配置，用于压测和上线前验证。
- **生产环境（prod）**：
  - 多节点、高可用部署，严格变更流程。

通过上述部署规划，可以在初期满足 1 万级并发的需求，并保留通过水平扩展进一步提升容量的空间。

